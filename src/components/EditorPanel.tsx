'use client'

import React, { useState } from 'react'
import { Link, Sparkles, Image, Type, Tag, FileText, Quote, Download, Copy, Check, Share2, History, Trash2, Clock, ChevronDown, ChevronUp } from 'lucide-react'
import { PosterData, HistoryRecord } from '@/types'

/**
 * ç¼–è¾‘å™¨é¢æ¿ Props
 */
interface EditorPanelProps {
  data: PosterData
  onChange: (data: Partial<PosterData>) => void
  onAnalyze: () => void
  onDownload: () => void
  isAnalyzing?: boolean
  autoGeneratedShareText?: string
  // å†å²è®°å½•ç›¸å…³
  history?: HistoryRecord[]
  onLoadHistory?: (record: HistoryRecord) => void
  onDeleteHistory?: (id: string) => void
  onClearHistory?: () => void
}

/**
 * è¡¨å•è¾“å…¥æ¡†ç»„ä»¶
 */
const FormInput: React.FC<{
  label: string
  icon: React.ReactNode
  value: string
  onChange: (value: string) => void
  placeholder?: string
  type?: 'text' | 'url'
}> = ({ label, icon, value, onChange, placeholder, type = 'text' }) => (
  <div className="space-y-2">
    <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
      {icon}
      {label}
    </label>
    <input
      type={type}
      value={value}
      onChange={(e) => onChange(e.target.value)}
      placeholder={placeholder}
      className="w-full px-4 py-2.5 border border-gray-200 rounded-lg text-sm
                 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500
                 transition-all duration-200"
    />
  </div>
)

/**
 * è¡¨å•æ–‡æœ¬åŸŸç»„ä»¶
 */
const FormTextarea: React.FC<{
  label: string
  icon: React.ReactNode
  value: string
  onChange: (value: string) => void
  placeholder?: string
  rows?: number
}> = ({ label, icon, value, onChange, placeholder, rows = 3 }) => (
  <div className="space-y-2">
    <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
      {icon}
      {label}
    </label>
    <textarea
      value={value}
      onChange={(e) => onChange(e.target.value)}
      placeholder={placeholder}
      rows={rows}
      className="w-full px-4 py-2.5 border border-gray-200 rounded-lg text-sm
                 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500/20 
                 focus:border-blue-500 transition-all duration-200"
    />
  </div>
)

/**
 * å†å²è®°å½•é¢æ¿ç»„ä»¶
 */
const HistoryPanel: React.FC<{
  history: HistoryRecord[]
  onLoad: (record: HistoryRecord) => void
  onDelete: (id: string) => void
  onClear: () => void
}> = ({ history, onLoad, onDelete, onClear }) => {
  const [isExpanded, setIsExpanded] = useState(false)

  // æ ¼å¼åŒ–æ—¶é—´æˆ³
  const formatTime = (timestamp: number) => {
    const date = new Date(timestamp)
    const now = new Date()
    const diffMs = now.getTime() - date.getTime()
    const diffMins = Math.floor(diffMs / (1000 * 60))
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60))
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24))

    if (diffMins < 1) return 'åˆšåˆš'
    if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`
    if (diffHours < 24) return `${diffHours}å°æ—¶å‰`
    if (diffDays < 7) return `${diffDays}å¤©å‰`
    
    return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' })
  }

  if (history.length === 0) {
    return null
  }

  return (
    <div className="border border-gray-200 rounded-lg overflow-hidden">
      {/* æŠ˜å æ ‡é¢˜ */}
      <button
        onClick={() => setIsExpanded(!isExpanded)}
        className="w-full flex items-center justify-between px-4 py-3 bg-gray-50 
                   hover:bg-gray-100 transition-colors"
      >
        <div className="flex items-center gap-2 text-sm font-medium text-gray-700">
          <History size={16} className="text-gray-500" />
          å†å²è®°å½•
          <span className="px-1.5 py-0.5 bg-gray-200 text-gray-600 text-xs rounded-full">
            {history.length}
          </span>
        </div>
        {isExpanded ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
      </button>

      {/* å†å²åˆ—è¡¨ */}
      {isExpanded && (
        <div className="max-h-64 overflow-y-auto">
          {history.map((record) => (
            <div
              key={record.id}
              className="flex items-center justify-between px-4 py-3 border-t border-gray-100
                         hover:bg-blue-50/50 transition-colors group"
            >
              {/* è®°å½•ä¿¡æ¯ */}
              <button
                onClick={() => onLoad(record)}
                className="flex-1 text-left"
              >
                <p className="text-sm font-medium text-gray-800 truncate max-w-[180px]">
                  {record.data.title || 'æœªå‘½å'}
                </p>
                <p className="flex items-center gap-1 text-xs text-gray-400 mt-0.5">
                  <Clock size={12} />
                  {formatTime(record.timestamp)}
                </p>
              </button>

              {/* åˆ é™¤æŒ‰é’® */}
              <button
                onClick={(e) => {
                  e.stopPropagation()
                  onDelete(record.id)
                }}
                className="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 
                           rounded-md opacity-0 group-hover:opacity-100 transition-all"
                title="åˆ é™¤è®°å½•"
              >
                <Trash2 size={14} />
              </button>
            </div>
          ))}

          {/* æ¸…ç©ºæŒ‰é’® */}
          {history.length > 0 && (
            <button
              onClick={onClear}
              className="w-full px-4 py-2 text-xs text-gray-400 hover:text-red-500 
                         border-t border-gray-100 hover:bg-red-50/50 transition-colors"
            >
              æ¸…ç©ºæ‰€æœ‰è®°å½•
            </button>
          )}
        </div>
      )}
    </div>
  )
}

/**
 * åˆ†äº«æ–‡æ¡ˆç”Ÿæˆå™¨ç»„ä»¶
 */
const ShareTextGenerator: React.FC<{ data: PosterData; autoGeneratedText?: string }> = ({ data, autoGeneratedText }) => {
  const [shareText, setShareText] = useState('')
  const [isCopied, setIsCopied] = useState(false)
  const [isExpanded, setIsExpanded] = useState(false)
  const [isGenerating, setIsGenerating] = useState(false)

  // å½“æ”¶åˆ°è‡ªåŠ¨ç”Ÿæˆçš„æ–‡æ¡ˆæ—¶ï¼Œè‡ªåŠ¨æ˜¾ç¤º
  React.useEffect(() => {
    console.log('ShareTextGenerator useEffect è§¦å‘, autoGeneratedText:', autoGeneratedText)
    if (autoGeneratedText && autoGeneratedText.trim()) {
      console.log('è‡ªåŠ¨å±•å¼€åˆ†äº«æ–‡æ¡ˆï¼ŒisExpanded å°†è®¾ç½®ä¸º true')
      setShareText(autoGeneratedText)
      setIsExpanded(true)
      console.log('isExpanded å·²è®¾ç½®, shareText:', autoGeneratedText.substring(0, 30) + '...')
    }
  }, [autoGeneratedText])

  /**
   * ç”Ÿæˆåˆ†äº«æ–‡æ¡ˆ
   */
  const generateShareText = async () => {
    if (!data.title || !data.description) {
      alert('è¯·å…ˆç”Ÿæˆæµ·æŠ¥å†…å®¹')
      return
    }

    setIsGenerating(true)
    try {
      console.log('å¼€å§‹ç”Ÿæˆåˆ†äº«æ–‡æ¡ˆ...')
      
      // è°ƒç”¨ API ç”Ÿæˆåˆ†äº«æ–‡æ¡ˆ
      const response = await fetch('/api/generate-share', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: data.title,
          description: data.description,
          tags: data.tags,
        }),
      })
      
      const result = await response.json()
      
      if (!response.ok || !result.success) {
        throw new Error(result.error || 'ç”Ÿæˆå¤±è´¥')
      }
      
      console.log('AI ç”Ÿæˆçš„åˆ†äº«æ–‡æ¡ˆ:', result.shareText)
      console.log('åˆ†äº«æ–‡æ¡ˆé•¿åº¦:', result.shareText?.length || 0)
      
      // ç»„è£…æœ€ç»ˆæ–‡æ¡ˆ
      const text = `ğŸ¬ ${data.title}

${result.shareText}

ğŸ·ï¸ ${data.tags.join(' Â· ')}

â€”â€” æ¥è‡ªè€çº¦ç¿°ã€Œå‘¨æœ«æ”¾æ˜ å®¤ã€ç²¾é€‰æ¨è`

      console.log('æœ€ç»ˆæ–‡æ¡ˆé•¿åº¦:', text.length)
      setShareText(text)
      setIsExpanded(true)
      
    } catch (error) {
      console.error('ç”Ÿæˆåˆ†äº«æ–‡æ¡ˆå¤±è´¥:', error)
      alert(`ç”Ÿæˆå¤±è´¥ï¼š${error instanceof Error ? error.message : 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'}`)
    } finally {
      setIsGenerating(false)
    }
  }

  /**
   * å¤åˆ¶åˆ°å‰ªè´´æ¿
   */
  const copyToClipboard = async () => {
    try {
      await navigator.clipboard.writeText(shareText)
      setIsCopied(true)
      setTimeout(() => setIsCopied(false), 2000)
    } catch (error) {
      console.error('å¤åˆ¶å¤±è´¥:', error)
      alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶')
    }
  }

  return (
    <div className="space-y-3">
      {/* ç”ŸæˆæŒ‰é’® */}
      <button
        onClick={generateShareText}
        disabled={!data.title || !data.description || isGenerating}
        className="w-full flex items-center justify-center gap-2 px-4 py-2.5 
                   bg-gradient-to-r from-purple-500 to-pink-500 text-white 
                   rounded-lg font-medium text-sm shadow-md
                   hover:shadow-lg hover:-translate-y-0.5
                   disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0
                   transition-all duration-200"
      >
        <Share2 size={16} />
        {isGenerating ? 'AI ç”Ÿæˆä¸­...' : (shareText ? 'é‡æ–°ç”Ÿæˆæ–‡æ¡ˆ' : 'ç”Ÿæˆåˆ†äº«æ–‡æ¡ˆ')}
      </button>

      {/* æ–‡æ¡ˆæ˜¾ç¤ºåŒºåŸŸ */}
      {isExpanded && shareText && (
        <div className="relative">
          <div className="bg-gradient-to-br from-purple-50 to-pink-50 border border-purple-200 rounded-lg p-4">
            <pre className="text-sm text-gray-700 whitespace-pre-wrap font-sans">
              {shareText}
            </pre>
          </div>
          
          {/* å¤åˆ¶æŒ‰é’® */}
          <button
            onClick={copyToClipboard}
            className="absolute top-2 right-2 flex items-center gap-1 px-3 py-1.5 
                       bg-white/90 backdrop-blur-sm border border-purple-300 
                       rounded-md text-xs font-medium text-purple-600
                       hover:bg-purple-50 transition-colors"
          >
            {isCopied ? (
              <>
                <Check size={14} />
                å·²å¤åˆ¶
              </>
            ) : (
              <>
                <Copy size={14} />
                å¤åˆ¶
              </>
            )}
          </button>
        </div>
      )}
    </div>
  )
}

/**
 * ç¼–è¾‘å™¨é¢æ¿ç»„ä»¶
 * æä¾›è¡¨å•æ§ä»¶ç”¨äºç¼–è¾‘æµ·æŠ¥æ•°æ®
 */
const EditorPanel: React.FC<EditorPanelProps> = ({
  data,
  onChange,
  onAnalyze,
  onDownload,
  isAnalyzing = false,
  autoGeneratedShareText,
  history = [],
  onLoadHistory,
  onDeleteHistory,
  onClearHistory,
}) => {
  // å¤åˆ¶çŠ¶æ€
  const [copied, setCopied] = useState(false)

  /**
   * å¤„ç†æ ‡ç­¾è¾“å…¥å˜åŒ–
   * å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„
   */
  const handleTagsChange = (value: string) => {
    const tags = value.split(/[,ï¼Œ]/).map(tag => tag.trim()).filter(Boolean)
    onChange({ tags })
  }

  /**
   * å¤„ç†å°é¢å›¾ä¸Šä¼ 
   */
  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (file) {
      const reader = new FileReader()
      reader.onload = (event) => {
        onChange({ coverImage: event.target?.result as string })
      }
      reader.readAsDataURL(file)
    }
  }

  /**
   * ç”Ÿæˆç¤¾ç¾¤åˆ†äº«æ–‡æ¡ˆ
   */
  const generateShareText = (): string => {
    const emoji = 'ğŸ¬'
    const separator = '\nâ”â”â”â”â”â”â”â”â”â”â”\n'
    
    let shareText = `${emoji} ${data.title || 'ç²¾å½©åŠ¨ç”»çŸ­ç‰‡'}\n`
    
    // æ·»åŠ æ ‡ç­¾
    if (data.tags && data.tags.length > 0) {
      shareText += `\nğŸ·ï¸ ${data.tags.join(' Â· ')}\n`
    }
    
    shareText += separator
    
    // æ·»åŠ ç®€ä»‹
    if (data.description) {
      shareText += `ğŸ“– ${data.description}\n`
    }
    
    shareText += separator
    
    // æ·»åŠ æ¨èè¯­
    if (data.recommendation) {
      shareText += `ğŸ’¬ ${data.recommendation}\n`
    }
    
    shareText += separator
    
    // æ·»åŠ é“¾æ¥
    if (data.videoUrl) {
      shareText += `ğŸ”— è§‚çœ‹é“¾æ¥ï¼š\n${data.videoUrl}\n`
    }
    
    shareText += `\nâœ¨ ${data.brandName || 'å‘¨æœ«æ”¾æ˜ å®¤'} Â· ç²¾é€‰ä¼˜è´¨å„¿ç«¥åŠ¨ç”»çŸ­ç‰‡`
    
    return shareText
  }

  /**
   * å¤åˆ¶åˆ†äº«æ–‡æ¡ˆåˆ°å‰ªè´´æ¿
   */
  const handleCopyShareText = async () => {
    try {
      const shareText = generateShareText()
      await navigator.clipboard.writeText(shareText)
      setCopied(true)
      setTimeout(() => setCopied(false), 2000)
    } catch (error) {
      console.error('å¤åˆ¶å¤±è´¥:', error)
      alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•')
    }
  }

  return (
    <div className="h-full flex flex-col bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
      {/* é¢æ¿æ ‡é¢˜ */}
      <div className="px-6 py-4 border-b border-gray-100">
        <h2 className="text-lg font-semibold text-gray-800">æµ·æŠ¥ç¼–è¾‘å™¨</h2>
        <p className="text-sm text-gray-500 mt-1">è¾“å…¥è§†é¢‘é“¾æ¥ï¼ŒAI å¸®ä½ ç”Ÿæˆç²¾ç¾æ–‡æ¡ˆ</p>
      </div>

      {/* è¡¨å•å†…å®¹åŒº - å¯æ»šåŠ¨ */}
      <div className="flex-1 overflow-y-auto px-6 py-5 space-y-5">
        {/* è§†é¢‘é“¾æ¥è¾“å…¥ */}
        <FormInput
          label="è§†é¢‘é“¾æ¥"
          icon={<Link size={16} className="text-gray-400" />}
          value={data.videoUrl}
          onChange={(value) => onChange({ videoUrl: value, qrCodeUrl: value })}
          placeholder="ç²˜è´´ Bç«™ã€YouTube ç­‰è§†é¢‘é“¾æ¥"
          type="url"
        />

        {/* AI æ™ºèƒ½åˆ†ææŒ‰é’® */}
        <button
          onClick={onAnalyze}
          disabled={isAnalyzing || !data.videoUrl}
          className="w-full flex items-center justify-center gap-2 px-4 py-3 
                     bg-gradient-to-r from-blue-500 to-indigo-600 text-white 
                     rounded-lg font-medium text-sm shadow-lg shadow-blue-500/25
                     hover:shadow-xl hover:shadow-blue-500/30 hover:-translate-y-0.5
                     disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0
                     transition-all duration-200"
        >
          <Sparkles size={18} />
          {isAnalyzing ? 'æ­£åœ¨åˆ†æä¸­...' : 'AI æ™ºèƒ½åˆ†æ'}
        </button>

        {/* åˆ†éš”çº¿ */}
        <div className="relative">
          <div className="absolute inset-0 flex items-center">
            <div className="w-full border-t border-gray-200"></div>
          </div>
          <div className="relative flex justify-center text-sm">
            <span className="px-3 bg-white text-gray-400">æ‰‹åŠ¨ç¼–è¾‘</span>
          </div>
        </div>

        {/* å°é¢å›¾ä¸Šä¼  */}
        <div className="space-y-2">
          <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
            <Image size={16} className="text-gray-400" />
            å°é¢å›¾ç‰‡
          </label>
          <div className="relative">
            <input
              type="file"
              accept="image/*"
              onChange={handleImageUpload}
              className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
            />
            <div className="flex items-center justify-center gap-2 px-4 py-3 border-2 border-dashed 
                            border-gray-200 rounded-lg text-gray-500 text-sm
                            hover:border-blue-400 hover:text-blue-500 transition-colors">
              <Image size={18} />
              ç‚¹å‡»ä¸Šä¼ å°é¢å›¾ç‰‡
            </div>
          </div>
          {data.coverImage && data.coverImage !== '/mock-cover.jpg' && (
            <p className="text-xs text-green-600">âœ“ å·²ä¸Šä¼ å°é¢å›¾</p>
          )}
        </div>

        {/* æ ‡é¢˜è¾“å…¥ */}
        <FormInput
          label="è§†é¢‘æ ‡é¢˜"
          icon={<Type size={16} className="text-gray-400" />}
          value={data.title}
          onChange={(value) => onChange({ title: value })}
          placeholder="è¾“å…¥è§†é¢‘æ ‡é¢˜"
        />

        {/* æ ‡ç­¾è¾“å…¥ */}
        <FormInput
          label="æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰"
          icon={<Tag size={16} className="text-gray-400" />}
          value={data.tags.join('ï¼Œ')}
          onChange={handleTagsChange}
          placeholder="å¦‚ï¼šå›½å¤–åŠ¨ç”»ï¼Œå¥¥æ–¯å¡è·å¥–"
        />

        {/* è§†é¢‘ç®€ä»‹ */}
        <FormTextarea
          label="è§†é¢‘ç®€ä»‹"
          icon={<FileText size={16} className="text-gray-400" />}
          value={data.description}
          onChange={(value) => onChange({ description: value })}
          placeholder="ç®€è¦æè¿°è§†é¢‘å†…å®¹ï¼Œçº¦ 60 å­—"
          rows={3}
        />

        {/* æ¨èç†ç”± */}
        <FormTextarea
          label="æ¨èç†ç”±"
          icon={<Quote size={16} className="text-gray-400" />}
          value={data.recommendation}
          onChange={(value) => onChange({ recommendation: value })}
          placeholder="å†™ä¸€æ®µèµ°å¿ƒçš„æ¨èè¯­ï¼Œçº¦ 50 å­—"
          rows={4}
        />

        {/* åˆ†äº«æ–‡æ¡ˆç”Ÿæˆ */}
        <ShareTextGenerator data={data} autoGeneratedText={autoGeneratedShareText} />

        {/* å†å²è®°å½• */}
        {history.length > 0 && onLoadHistory && onDeleteHistory && onClearHistory && (
          <HistoryPanel
            history={history}
            onLoad={onLoadHistory}
            onDelete={onDeleteHistory}
            onClear={onClearHistory}
          />
        )}
      </div>

      {/* åº•éƒ¨ä¸‹è½½æŒ‰é’® */}
      <div className="px-6 py-4 border-t border-gray-100 bg-gray-50">
        <button
          onClick={onDownload}
          className="w-full flex items-center justify-center gap-2 px-4 py-3 
                     bg-gray-900 text-white rounded-lg font-medium text-sm
                     hover:bg-gray-800 transition-colors duration-200"
        >
          <Download size={18} />
          ä¸‹è½½æµ·æŠ¥
        </button>
      </div>
    </div>
  )
}

export default EditorPanel
